package com.github.fengleicn.dht.modules;

import com.github.fengleicn.dht.utils.structs.KBucketNode;
import com.github.fengleicn.dht.utils.structs.UdpPacket;
import com.github.fengleicn.dht.utils.UdpUtils;
import com.github.fengleicn.dht.modules.UdpContoller;
import com.github.fengleicn.dht.utils.structs.KBucket;
import com.github.fengleicn.dht.utils.Utils;

import java.net.*;

public class StartUp {
    public static KBucketNode myKBucketNode;
    UdpContoller networkController;
    int myPort;

    private static final int SEC = 1000;
    private static final int GET_PEER_MS = 10;
    private static final int FIND_NODE_MS = 10;
    private static final int CHANGE_NODE_ID_MS = 1000 * SEC;
    public static final String GET_PEER_INFO_HASH = "EEB7C79987A49F3CA816A951C404350A83C23C3C";

    public StartUp(String myIp, int myPort) throws SocketException, UnknownHostException {
        this.myPort = myPort;
        myKBucketNode = new KBucketNode(Utils.randomBytes(20), Utils.getBytesFromHost(myIp), Utils.getBytesFromInt(myPort));
        KBucket kBucket = new KBucket(myKBucketNode);
        UdpUtils.set(kBucket);
        networkController = new UdpContoller(new DatagramSocket(myPort));
    }

    private void initKBucketNodes() throws UnknownHostException {
        String[] urls = {
                "router.utorrent.com:6881",
                "router.bittorrent.com:6881",
                "dht.transmissionbt.com:6881",
                "39.72.233.66:13812",
                "94.21.129.147:24499",
                "119.197.196.61:51413",
                "136.56.77.167:8999",
                "119.64.162.153:6881",
                "130.204.148.154:54237",
                "140.119.65.88:51413",
                "5.12.239.197:10052",
                "108.31.152.110:6889",
                "115.39.24.101:6881",
                "175.214.171.161:61469",
                "185.45.195.193:28177",
                "181.132.74.40:24571",
                "176.215.244.99:42663",
                "188.134.81.181:17003",
                "182.113.244.110:9619",
                "89.212.113.70:55320",
                "2.87.78.8:6881",
                "109.160.18.75:40004",
                "195.154.136.35:51413",
                "88.245.1.122:6881",
                "104.238.161.147:51413",
                "23.28.180.32:6881",
                "114.35.138.160:6881",
                "24.130.182.245:48763",
                "111.97.177.169:43308",
                "111.8.128.217:2181",
                "176.138.20.135:49582",
                "213.178.56.198:51413",
                "185.109.86.168:49001",
                "77.234.81.49:10618",
                "45.73.120.223:33048",
                "178.209.22.206:14234",
                "94.23.41.18:51413",
                "5.167.232.105:10635",
                "185.45.195.178:28082",
                "46.40.120.92:22562",
                "220.94.150.165:11210",
                "221.138.52.47:51413",
                "159.255.1.180:49001",
                "89.68.208.175:6881",
                "115.57.136.210:15408",
                "54.245.82.246:13848",
                "185.45.195.174:28143",
                "46.188.126.116:65415",
                "175.197.36.189:48738",
                "46.214.110.233:26301",
                "112.172.129.6:51413",
                "98.240.228.140:38113",
                "188.143.118.180:51413",
                "80.237.100.18:31929",
                "77.37.205.3:14491",
                "87.231.72.230:6889",
                "36.56.59.189:6006",
                "84.238.186.122:23017",
                "84.236.37.2:48379",
                "47.186.230.29:49634",
                "71.59.21.183:44304",
                "204.83.119.242:50321",
                "180.94.174.114:8779",
                "181.223.10.204:16207",
                "173.249.19.73:12040",
                "45.112.165.92:41086",
                "80.7.15.251:50547",
                "123.129.249.177:51413",
                "95.211.246.33:51413",
                "177.188.152.253:31401",
                "62.210.109.157:55040",
                "45.32.34.60:51413",
                "115.136.78.189:30753",
                "24.129.97.95:44505",
                "58.1.70.163:29474",
                "77.37.232.120:16847",
                "89.25.41.17:39015",
                "153.183.71.52:6881",
                "14.9.140.64:30925",
                "178.48.104.95:11136",
                "91.61.181.224:6889",
                "190.98.45.75:61194",
                "92.30.208.60:44126",
                "2.108.135.215:37748",
                "178.41.146.167:22477",
                "171.243.190.249:36113",
                "5.39.89.117:6881",
                "223.167.169.247:27651",
                "37.228.253.101:38521",
                "79.179.71.85:51413",
                "85.113.60.98:9888",
                "77.234.50.218:62419",
                "1.43.206.22:40298",
                "94.26.30.200:33252",
                "213.57.251.164:56387",
                "112.168.201.21:64904",
                "118.47.195.215:40980",
                "37.16.82.33:5047",
                "218.148.213.54:18462",
                "173.255.19.229:60822",
                "216.8.143.242:6881",
                "212.50.15.94:59669",
                "60.137.21.152:6881",
                "198.48.237.46:6881",
                "5.196.95.174:51413",
                "85.17.21.114:51413",
                "109.219.241.153:16651",
                "66.112.223.196:51413",
                "76.177.162.129:6881",
                "85.196.249.49:41663",
                "81.109.139.113:6881",
                "95.53.232.181:50708",
                "90.154.72.5:4147",
                "60.128.23.56:6881",
                "91.79.101.124:17698",
                "73.104.210.123:50321",
                "190.200.68.203:63663",
                "124.208.64.76:36580",
                "163.172.164.156:55002",
                "185.21.216.160:56864",
                "52.144.117.220:8999",
                "124.244.200.138:57706",
                "194.176.236.54:51635",
                "85.67.91.244:18850",
                "68.228.171.79:8999",
                "128.68.140.70:14407",
                "220.117.158.131:38502",
                "122.100.130.37:7118",
                "123.1.38.227:6881",
                "218.90.32.188:51413",
                "5.79.77.50:43201",
                "78.131.119.68:13307",
                "62.73.84.70:54087",
                "108.172.131.35:62458",
                "82.64.55.31:51413",
                "128.68.59.184:59152",
                "212.235.107.215:8999",
                "39.118.69.65:54046",
                "86.242.237.133:51413",
                "37.142.158.136:29082",
                "207.164.227.225:10064",
                "94.41.78.184:56070",
                "1.217.49.50:59005",
                "123.185.204.244:7645",
                "173.246.9.99:13970",
                "175.193.77.214:31358",
                "5.39.88.230:51413",
                "14.199.167.132:6881",
                "78.83.230.247:10498",
                "37.48.89.199:42118",
                "85.17.24.158:51413",
                "195.154.176.39:55151",
                "178.32.221.17:51413",
                "73.49.27.95:8999",
                "46.188.18.241:50057",
                "121.248.60.28:6881",
                "35.204.209.7:51413",
                "74.59.135.52:41700",
                "49.113.119.26:11716",
                "222.116.209.119:7966",
                "67.193.255.224:62981",
                "195.218.183.72:5530",
                "27.95.98.5:6889",
                "101.68.0.68:6339",
                "71.185.55.130:65475",
                "97.99.226.255:37338",
                "37.223.27.219:34177",
                "178.21.52.116:47895",
                "72.180.163.89:50321",
                "179.6.210.3:10251",
                "83.139.179.37:3845",
                "72.78.192.140:6881",
                "81.110.28.50:6881",
                "77.111.160.200:19852",
                "5.103.155.228:6881",
                "220.89.189.235:49682",
                "183.248.203.90:18458",
                "108.250.163.31:51413",
                "75.174.192.178:62430",
                "1.234.141.69:40911",
                "210.178.108.167:8720",
                "213.144.20.133:54204",
                "95.91.235.135:8655",
                "86.97.69.73:33300",
                "37.204.125.23:12955",
                "82.64.47.207:6881",
                "176.114.188.225:10808",
                "185.45.195.189:28112",
                "211.226.150.194:58402",
                "176.63.153.114:8999",
                "5.79.83.209:51413",
                "175.123.37.21:40708",
                "173.252.4.36:6881",
                "89.201.65.189:11241",
                "78.83.100.154:10201",
                "94.226.135.171:45261",
                "106.165.148.127:44554",
                "71.229.235.109:6881",
                "85.66.22.72:8999",
                "185.21.217.57:59767",
                "24.150.236.100:52435",
                "114.241.106.220:6339",
                "198.166.93.33:21166",
                "73.221.57.20:51413",
                "91.77.166.104:62348",
                "72.53.25.10:22345",
                "222.209.130.78:9006",
                "49.206.114.84:11439",
                "89.169.84.198:55157",
                "46.6.10.226:5089",
                "182.229.15.2:8999",
                "79.164.127.122:51413",
                "93.47.217.213:59089",
                "91.208.36.40:51414",
                "176.63.61.97:8999",
                "47.9.68.166:49970",
                "14.223.93.26:7825",
                "179.177.189.25:35684",
                "109.23.248.10:51413",
                "70.30.33.117:8999",
                "210.128.207.122:6881",
                "49.80.146.212:29930",
                "61.93.159.124:24434",
                "158.58.244.42:40008",
                "72.76.106.23:22950",
                "221.225.84.137:1701",
                "149.56.114.207:53976",
                "94.236.182.44:41515",
                "86.99.201.241:40338",
                "79.122.109.193:48916",
                "87.59.43.61:63546",
                "94.23.49.224:51421",
                "118.240.73.253:24666",
                "222.70.178.158:6881",
                "37.48.111.238:46065",
                "113.12.183.212:21511",
                "31.31.234.99:41669",
                "5.103.35.182:6889",
                "80.99.16.223:15599",
                "92.247.61.55:6889",
                "109.252.197.10:42610",
                "37.189.80.238:6881",
                "80.8.234.217:62395",
                "178.184.84.140:34013",
                "144.34.151.95:51413",
                "189.7.29.233:50321",
                "81.254.34.194:51413",
                "100.15.236.222:51413",
                "123.142.111.123:58007",
                "78.57.244.55:63726",
                "86.158.80.79:6881",
                "151.237.128.54:10187",
                "84.144.60.176:22347",
                "115.79.202.14:8607",
                "212.5.152.30:6881",
                "195.146.66.219:6881",
                "45.70.172.130:30221",
                "89.215.151.58:29402",
                "109.74.132.35:63233",
                "199.172.220.100:6881",
                "188.156.213.143:28933",
                "93.123.117.250:8999",
                "1.59.180.165:28184",
                "185.162.184.5:52793",
                "151.230.105.177:14362",
                "108.24.92.83:51413",
                "139.162.101.6:51413",
                "5.79.75.194:6915",
                "181.220.215.12:51378",
                "73.61.160.170:13597",
                "80.197.155.24:44566",
                "179.113.250.218:16763",
                "178.140.37.146:6881",
                "88.210.91.70:6881",
                "119.36.23.61:11485",
                "218.63.205.121:40330",
                "68.229.96.159:22387",
                "47.25.64.100:6889",
                "95.95.202.218:44292",
                "176.63.14.184:11010",
                "24.77.21.151:15000",
                "61.114.146.182:48667",
                "178.48.112.206:55607",
                "5.166.0.68:44367",
                "92.55.18.163:24226",
                "86.194.33.7:63312",
                "115.70.14.58:50991",
                "91.216.61.39:62969",
                "84.72.5.190:6889",
                "192.131.44.93:65124",
                "5.18.102.31:11743",
                "89.238.1.174:6889",
                "83.228.111.79:1025",
                "185.202.173.194:11438",
                "51.68.37.221:28011",
                "73.86.41.112:41920",
                "74.249.97.29:16411",
                "78.208.75.36:62546",
                "178.140.129.6:51413",
                "60.140.229.83:42799",
                "54.70.17.106:8110",
                "62.192.252.77:64318",
                "176.195.120.236:53420",
                "149.62.17.27:24114",
                "95.72.127.36:46708",
                "138.118.87.4:63694",
                "211.125.210.30:6881",
                "86.126.165.111:8999",
                "95.158.164.44:18446",
                "112.118.220.54:27245",
                "118.206.15.84:52481",
                "91.210.201.38:11721",
                "46.249.234.227:8999",
                "78.45.75.137:8999",
                "190.47.49.252:11695",
                "153.204.22.169:21447",
                "81.95.137.18:37964",
                "68.100.165.209:41822",
                "92.249.137.137:30454",
                "221.234.237.46:6881",
                "79.100.104.46:51815",
                "149.202.63.43:51413",
                "95.82.225.250:64336",
                "115.95.147.42:41053",
                "68.228.238.29:50321",
                "93.170.96.118:52067",
                "31.5.170.152:64551",
                "121.159.141.143:6881",
                "42.2.17.192:6889",
                "176.15.229.33:40552",
                "101.240.49.84:1024",
                "75.164.81.239:6881",
                "46.10.105.112:42554",
                "187.19.86.212:51803",
                "94.75.237.252:51413",
                "144.76.29.36:51413",
                "42.2.142.226:12179",
                "178.207.18.8:51413",
                "95.211.241.89:51413",
                "198.57.54.22:6881",
                "155.93.215.173:64655",
                "113.154.31.105:6881",
                "92.249.249.24:63381",
                "198.98.50.93:9092",
                "188.143.57.25:51413",
                "84.238.155.142:36773",
                "195.154.174.8:51425",
                "185.45.195.185:28143",
                "185.21.217.60:50659",
                "104.238.138.98:51413",
                "91.181.92.221:6881",
                "109.110.79.11:39082",
                "90.154.138.254:53955",
                "125.132.119.225:56241",
                "178.117.47.2:6889",
                "89.132.168.107:56669",
                "101.244.102.233:54922",
                "50.88.237.104:42260",
                "2.97.150.215:21558",
                "46.236.146.159:23900",
                "194.12.80.60:31053",
                "124.197.113.121:6881",
                "46.32.68.200:27359",
                "31.20.219.125:44613",
                "51.15.176.133:50150",
                "62.210.137.209:8999",
                "95.73.93.246:36416",
                "51.174.115.63:20973",
                "95.149.237.46:24800",
                "108.16.205.212:65154",
                "77.252.196.233:60096",
                "77.71.4.147:54360",
                "112.39.152.51:24009",
                "192.131.44.89:58865",
                "94.21.136.28:27185",
                "210.6.8.220:6881",
                "176.214.120.38:46324",
                "109.73.20.108:55879",
                "195.154.179.244:55051",
                "46.233.21.184:36731",
                "124.18.224.153:48755",
                "91.139.155.107:58056",
                "153.207.52.89:47412",
                "213.141.248.57:23382",
                "85.229.6.82:51413",
                "93.183.189.110:64965",
                "51.15.178.170:6881",
                "187.63.99.251:47662",
                "114.149.46.46:59227",
                "159.117.79.57:7384",
                "79.134.51.122:50312",
                "94.199.48.109:6881",
                "213.102.90.251:53071",
                "92.124.205.49:1025",
                "108.52.171.73:51413",
                "45.77.153.128:51413",
                "177.134.254.183:11013",
                "51.15.69.20:51413",
                "86.101.78.95:36107",
                "188.254.207.7:31088",
                "183.202.2.111:6627",
                "37.232.149.72:56196"
        };
        for (String url : urls) {
            String[] urlSplit = url.split(":");
            String hostName = urlSplit[0];
            String port = urlSplit[1];
            UdpUtils.kBucket.add(new KBucketNode(Utils.randomBytes(20),
                    Utils.getBytesFromHost(hostName),
                    Utils.getBytesFromInt(Integer.parseInt(port))));
        }
    }

    private void findNodeTask() {
        while (true) {
            byte[] transId = new byte[]{'f', 'n'};
            byte[] targetId = Utils.randomBytes(20);
            try {
                Thread.sleep(FIND_NODE_MS);
                KBucketNode randomNode = UdpUtils.kBucket.randomNode();
                UdpPacket udpPacket = Utils.findNode(transId, myKBucketNode.nodeId, targetId,
                        new InetSocketAddress(randomNode.getIp(), randomNode.getPort()));
                networkController.send(udpPacket);
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }

    private void getPeerTask() {
        byte[] transId = new byte[]{'g', 'p'};
        while (true) {
            try {
                Thread.sleep(GET_PEER_MS);
                KBucketNode KBucketNode = UdpUtils.kBucket.randomNode();
                UdpPacket udpPacket = Utils.getPeer(transId, myKBucketNode.nodeId,
                        Utils.getBytesFromHex(GET_PEER_INFO_HASH), new InetSocketAddress(KBucketNode.getIp(), KBucketNode.getPort()));
                networkController.send(udpPacket);
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }

    private void manageUdpNetworkTask() {
        while (true) {
            try {
                UdpPacket udpPacket = networkController.recv();
                if (udpPacket != null) {
                    UdpPacket resp;
                    resp = UdpUtils.createResp(udpPacket, myKBucketNode.nodeId);
                    if (resp != null)
                        networkController.send(resp);
                }
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }

    private void changeNodeIdTask() {
        while (true) {
            try {
                Thread.sleep(CHANGE_NODE_ID_MS);
                myKBucketNode.nodeId = Utils.randomBytes(20);
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }

    public void startUp() throws Exception {
        initKBucketNodes();
        new Thread(this::findNodeTask, "FIND_NODE_THREAD").start();
        new Thread(this::getPeerTask, "GET_PEER_THREAD").start();
        new Thread(this::manageUdpNetworkTask, "HANDLER_THREAD").start();
        new Thread(this::changeNodeIdTask, "CHG_NODE_ID_THREAD").start();
    }
}





